ARG BUILD_ENV=docker
ARG TARGETPLATFORM
ARG ARCH

FROM registry.suse.com/bci/bci-busybox:15.7 AS base

FROM base AS copy_docker
ONBUILD ARG ARCH
ONBUILD COPY bin/fleetagent-linux-$ARCH /usr/bin/fleetagent

FROM base AS copy_buildx
ONBUILD ARG TARGETARCH
ONBUILD COPY bin/fleetagent-linux-$TARGETARCH /usr/bin/fleetagent

FROM base AS copy_goreleaser
ARG TARGETPLATFORM
COPY ${TARGETPLATFORM}/fleetagent-linux-* /usr/bin/fleetagent

FROM copy_${BUILD_ENV}
USER 1000
CMD ["fleetagent"]
