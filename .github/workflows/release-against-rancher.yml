name: Release Fleet against rancher/rancher
on:
  workflow_dispatch:
    inputs:
      rancher_ref:
        description: "Submit PR against the following rancher/rancher branch (e.g. release/v2.13 or main if there is no according release branch yet)"
        required: true
        default: "release/v2.13"
      new_fleet:
        description: "New Fleet version (e.g. 0.14.0-rc.1)"
        required: true
        default: ""
      new_chart:
        description: "New Rancher Chart version (e.g. 108.0.0)"
        required: true
        default: ""
      should_bump_api:
        description: "Should the Fleet api be bumped in the Rancher repo? (If the API in github.com/rancher/fleet/pkg/apis has changed or the release is for a final release, then the API needs to be bumped (set to true ), otherwise use false .)"
        required: true
        default: "false"
      go_version:
        description: "Go version used for bumping the api. This should be the same version as in the go.mod file of the project."
        required: true
        default: '1.24.*'

env:
  GOARCH: amd64
  CGO_ENABLED: 0
  SETUP_GO_VERSION: ${{github.event.inputs.go_version}}

jobs:
  create-rancher-pr:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          path: fleet
      - name: Checkout rancher/rancher
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0
          repository: rancher/rancher
          ref: ${{github.event.inputs.rancher_ref}}
          path: rancher
      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6
        with:
          go-version: ${{ env.SETUP_GO_VERSION }}
      - name: Install controller-gen
        run: go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.17.2
      - name: Run release script
        run: |
          export CHARTS_DIR="${GITHUB_WORKSPACE}/rancher"
          ./fleet/.github/scripts/release-against-rancher.sh ${{github.event.inputs.new_fleet}} ${{github.event.inputs.new_chart}} ${{github.event.inputs.should_bump_api}}
      - name: Create Pull Request
        env:
          GITHUB_TOKEN: ${{ secrets.PUSH_TO_FORKS_SUBMIT_PRS }}
        working-directory: ./rancher/
        run: |
          ../fleet/.github/scripts/create-pr.sh ${{github.event.inputs.rancher_ref}} ${{github.event.inputs.new_fleet}} ${{github.event.inputs.new_chart}} rancher
