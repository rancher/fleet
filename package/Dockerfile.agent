ARG BUILD_ENV=dapper

FROM registry.suse.com/bci/bci-base:15.5.36.5.66 AS base
COPY package/log.sh /usr/bin/
# Remove curl to reduce vulnerability count in scans
# Create non-root user and group
RUN zypper rm -y curl && zypper in -y pwdutils && groupadd -g 1000 fleet-apply && useradd -u 1000 -g fleet-apply fleet-apply

FROM base AS copy_dapper
ONBUILD ARG ARCH
ONBUILD COPY bin/fleetagent-linux-$ARCH /usr/bin/fleetagent
ONBUILD COPY bin/fleet-linux-$ARCH /usr/bin/fleet

FROM base AS copy_buildx
ONBUILD ARG TARGETARCH
ONBUILD COPY bin/fleetagent-linux-$TARGETARCH /usr/bin/fleetagent
ONBUILD COPY bin/fleet-linux-$TARGETARCH /usr/bin/fleet

FROM copy_${BUILD_ENV}
USER 1000
CMD ["fleetagent"]
