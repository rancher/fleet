suite: additional known_hosts tests
tests:
  - it: should set additional known_hosts entries in the known-hosts config map
    set:
      additionalKnownHosts:
        - '[foo.bar.baz]:2222 ecdsa-sha2-nistp256 AAANhLXNoYTItbmlzdHAyNTdHAyNTYAAABBBJ6cPcyaL4gbQHb1+3EFuDhT1yqmH/IWid60KddIcPLKG6QRnU0UVCZb/SqvM7YqrAMWTJU3382yUbIcvhkZZnU='
        - 'my.custom.host ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl'
    template: configmap_known_hosts.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      # no assertions made on fingerprints of default entries, as those may evolve over time.
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'bitbucket\.org ecdsa-sha2-nistp256'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'bitbucket\.org ssh-ed25519'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'bitbucket\.org ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'github\.com ecdsa-sha2-nistp256'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'github\.com ssh-ed25519'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'github\.com ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'gitlab\.com ecdsa-sha2-nistp256'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'gitlab\.com ssh-ed25519'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'gitlab\.com ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'ssh\.dev\.azure\.com ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'vs-ssh\.visualstudio\.com ssh-rsa'
      # custom entries must appear without leading whitespace
      - matchRegex:
          path: data["known_hosts"]
          pattern: '\[foo\.bar\.baz\]:2222 ecdsa-sha2-nistp256'
      - notMatchRegex:
          path: data["known_hosts"]
          pattern: ' +\[foo\.bar\.baz\]'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'my\.custom\.host ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIOMqqnkVzrm0SdG6UOoqKLsabgH5C9okWi0dh2l9GKJl'
      - notMatchRegex:
          path: data["known_hosts"]
          pattern: ' +my\.custom\.host'
      # no raw Helm template markers must leak into the rendered value
      - notMatchRegex:
          path: data["known_hosts"]
          pattern: '\{\{-? range'

  - it: should leave the config map untouched if no additional entries are set
    set:
      additionalKnownHosts: {}
    template: configmap_known_hosts.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ConfigMap
      # no assertions made on fingerprints of default entries, as those may evolve over time.
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'bitbucket\.org ecdsa-sha2-nistp256'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'bitbucket\.org ssh-ed25519'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'bitbucket\.org ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'github\.com ecdsa-sha2-nistp256'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'github\.com ssh-ed25519'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'github\.com ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'gitlab\.com ecdsa-sha2-nistp256'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'gitlab\.com ssh-ed25519'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'gitlab\.com ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'ssh\.dev\.azure\.com ssh-rsa'
      - matchRegex:
          path: data["known_hosts"]
          pattern: 'vs-ssh\.visualstudio\.com ssh-rsa'
      # no raw Helm template markers must leak into the rendered value
      - notMatchRegex:
          path: data["known_hosts"]
          pattern: '\{\{-? range'
